âŒ Problem:
Our bulk image updater is generating incorrect, redundant, or malformed search queries â€” resulting in a <2% success rate, despite valid working examples via manual search.

ğŸ” Examples of whatâ€™s broken:
"marvel 1995 flair Cyclops #FM-73 FM-7" â† invalid and duplicated number suffixes

"1993 skybox marvel masterpieces thor 81" â† this query works manually but fails in bulk updater, meaning the logic is incorrectly formatting or executing the request

âœ… Required Fix:
ğŸ”§ 1. Search query must be constructed exactly as follows:
arduino
Copy
Edit
"{setName} {cardName} {cardNumber}"
Where:

setName = the full display name (e.g., "1993 SkyBox Marvel Masterpieces")

cardName = the character name (e.g., "Thor")

cardNumber = the exact value stored in the DB â€” including prefixes like FM-73, SP-1, #42, etc.

â— Do not strip or normalize the card number. Use it exactly as-is.
â— Do not append a second version (like FM-7) or try to duplicate it in the query.
âŒ "FM-73 FM-7" â†’ invalid
âœ… "1995 Flair Marvel Cyclops FM-73" â†’ correct

ğŸ”§ 2. Update the COMC Search Builder Logic
In server/comc-image-finder.ts (likely inside searchCOMCForCard()), do the following:

Construct the query exactly using:

ts
Copy
Edit
const query = `${setName} ${cardName} ${cardNumber}`;
Do not use any additional helpers that modify or duplicate cardNumber.

Ensure query is lowercased or formatted to match manual test strings if needed â€” but do not mutate cardNumber.

ğŸ§ª 3. Debug & Verify
Add debug logs before calling the eBay API:

ts
Copy
Edit
console.log(`[COMC DEBUG] Query: "${query}"`);
Run test lookups for known matches (e.g., Thor 81 from 1993 SkyBox) and confirm that queries exactly match working manual searches.

ğŸ§± File Targets to Update:
server/comc-image-finder.ts â€” primary focus: fix query builder

server/ebay-image-finder.ts â€” verify no conflicting fallback logic interfering

server/bulk-image-updater.ts â€” confirm that card.cardNumber is being passed in unchanged from the database

server/routes.ts â€” no change required unless logging is missing on the endpoint

ğŸ¯ Summary:
Fix query generator to only build {setName} {cardName} {cardNumber} with no transformations

Never strip or rewrite cardNumber

Never duplicate suffixes (e.g., "FM-73 FM-7" is invalid)

No fallback logic or normalization â€” accuracy matters more than hit rate

